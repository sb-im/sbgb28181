# sbgb28181 Pusher

[English](Readme_EN.md)

> **åŸºäº Python + GStreamer çš„è½»é‡çº§ GB28181 è®¾å¤‡ç¤ºä¾‹**â€”â€”è‡ªåŠ¨ REGISTERã€å“åº” INVITEï¼Œå¹¶ä½¿ç”¨ GStreamer æ¨é€ **PS/H.264** è§†é¢‘æµã€‚

æœ¬ä»“åº“æä¾›ä¸€ä¸ªç®€æ´çš„ **GB28181** å‚è€ƒå®ç°ï¼Œå¯å°†ä»»æ„è§†é¢‘æºæ¨¡æ‹Ÿä¸ºæ‘„åƒå¤´ä¾§è®¾å¤‡å¹¶æ¨æµåˆ° GB28181 åª’ä½“æœåŠ¡å™¨ã€‚ä¿¡ä»¤äº¤äº’ç”± Python è„šæœ¬è´Ÿè´£ï¼Œåª’ä½“å‘é€åˆ™ä¾èµ–è‡ªåˆ¶ `gb28181sink` GStreamer æ’ä»¶ã€‚

---

## ğŸ¯ ä¸»è¦ç‰¹æ€§

| åŠŸèƒ½                  | è¯´æ˜                                                          |
| ------------------- | ----------------------------------------------------------- |
| **TCP / UDP ä¿¡ä»¤**    | é»˜è®¤ä½¿ç”¨ TCPï¼Œå¯é€šè¿‡ `--udp` åˆ‡æ¢åˆ° UDP                                |
| **TCP / UDP åª’ä½“æµ**   | æ”¯æŒ UDP åŠ TCP *è¢«åŠ¨æ¨¡å¼* ä¼ è¾“è§†é¢‘æµ                                   |
| **æ ‡å‡† PS å°è£…**        | åŸºäº `gb28181sink` æ’ä»¶æ¨é€ç¬¦åˆå›½æ ‡çš„ PS æµï¼ˆ96/PT æˆ–æŒ‰ SDP åå•†ï¼‰            |
| **å‘½ä»¤è¡Œå‚æ•°åŒ–**          | å¹³å° IP/ç«¯å£ã€è®¾å¤‡/å¹³å° IDã€å¯†ç ç­‰å‡å¯åœ¨å¯åŠ¨æ—¶æŒ‡å®š                               |
| **è‡ªåŠ¨ REGISTER**     | å†…ç½® Digestâ€‘401 è´¨è¯¢å¤„ç†ï¼Œæ”¯æŒå¤šæ¬¡é‡è¯•                                   |
| **SDP / INVITE è§£æ** | æŒ‰ GB28181 è§„èŒƒä¼˜å…ˆé€‰æ‹© 96/PSã€98/H264 ç­‰ PayloadType                |
| **GStreamer æ¨æµ**    | æ ¹æ® SDP åŠ¨æ€æ‹¼è£… `gst-launch-1.0` pipelineï¼Œæ”¯æŒ PS/H.264 åŠ TCP/UDP |
| **å¿ƒè·³ä¸æŸ¥è¯¢å“åº”**         | å‘¨æœŸ *Keepalive*ï¼Œå¹¶å¯¹ *Catalog* / *DeviceInfo* æŸ¥è¯¢ä½œå‡ºå“åº”           |
| **è‡ªåŠ¨é‡è¿æœºåˆ¶**          | è¿æ¥æ–­å¼€æ—¶è‡ªåŠ¨é‡è¿ï¼Œå¯é…ç½®é‡è¿é—´éš”å’Œæœ€å¤§é‡è¯•æ¬¡æ•°                                  |
| **æ—¥å¿—ç³»ç»Ÿ**            | `--verbose` è¾“å‡ºå®Œæ•´ SIP æŠ¥æ–‡ï¼Œä¾¿äºæŠ“åŒ…ä¸è°ƒè¯•                             |

---

## ğŸ“¦ ä¾èµ–ç¯å¢ƒ

* **Python â‰¥ 3.9**ï¼ˆå·²åœ¨ Ubuntu 22.04 éªŒè¯ï¼‰
* **GStreamer â‰¥ 1.18** åŠè‡ªç¼–è¯‘çš„ `gb28181sink` æ’ä»¶

### å®‰è£… GStreamer åŠç¼–è¯‘ä¾èµ–
```bash
sudo apt update
sudo apt install -y gstreamer1.0-tools gstreamer1.0-plugins-base gstreamer1.0-plugins-good
sudo apt install -y meson ninja-build \
     libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev \
     libglib2.0-dev
```

### ç¼–è¯‘ gb28181sink æ’ä»¶
```bash
cd gst-gb28181sink
meson setup build
meson compile -C build
# å®‰è£…åˆ°ç³»ç»Ÿæ’ä»¶ç›®å½•(é»˜è®¤åœ¨/usr/local/lib/aarch64-linux-gnu/gstreamer-1.0)
sudo meson install -C build
# å¦‚æƒ³æ”¾ç”¨æˆ·ç›®å½•ï¼Œå¯è·³è¿‡ install å¹¶è®¾ç½®ï¼š
# export GST_PLUGIN_PATH=$PWD/build
# ç¡®è®¤æ’ä»¶å·²æ³¨å†Œ
gst-inspect-1.0 gb28181sink
# å¦‚æœæ‰¾ä¸åˆ°åˆ™æ‹·è´è¿‡å»
# sudo cp build/libgstgb28181sink.so /usr/lib/aarch64-linux-gnu/gstreamer-1.0/
```

### æœ¬åœ°æµ‹è¯•ç¤ºä¾‹
```bash
# TCPè¢«åŠ¨æ¨¡å¼
# æœ¬åœ°è¿è¡Œï¼Œç›‘å¬9527ç«¯å£
nc -l 9527 | hexdump -C | less
# æ–°å¼€ä¸ªçª—å£ï¼Œè¿è¡Œ
gst-launch-1.0 videotestsrc is-live=true ! video/x-raw,width=640,height=480,framerate=25/1 ! \
 x264enc key-int-max=50 tune=zerolatency bitrate=800 ! \
 h264parse ! mpegpsmux ! \
 gb28181sink protocol=tcp host=127.0.0.1 port=9527 pt=96 ssrc=0x01020304
# ç›‘å¬çš„ç«¯å£éœ€è¦èƒ½æ”¶åˆ°æ•°æ®
```


---

## ğŸš€ å¿«é€Ÿå¼€å§‹

```bash
python3 gb28181_pusher.py \
    --server-ip 192.168.1.100 --server-port 5060 \
    --server-id 11009000000000000000 --domain 1100900000 \
    --agent-id 300000000010000000000 --agent-password 000000 \
    --channel-id 340000000000000000000 \
    --source test \
    --verbose # æ˜¾ç¤ºæ‰€æœ‰ SIP åŒ…
# å¯æ ¹æ®éœ€è¦ï¼Œåœ¨gst_cmdå­—æ®µä¿®æ”¹æˆéœ€è¦çš„è§†é¢‘æº
```

> è‹¥å¹³å°ä½¿ç”¨ UDP ä¿¡ä»¤ï¼Œåœ¨æœ€ååŠ ä¸Š `--udp`ã€‚

å¯åŠ¨åè„šæœ¬å°†ï¼š

1. ä½¿ç”¨ SIP **REGISTER** ç™»å½•å¹³å°ã€‚
2. æ¯ 60 ç§’å‘é€ä¸€æ¬¡ **Keepalive**ã€‚
3. ç­‰å¾…å¹³å° **INVITE**ï¼Œæ”¶åˆ°åè‡ªåŠ¨ 100 Trying â†’ 200 OK å¹¶è§£æ SDPã€‚
4. æ ¹æ® SDP ç”¨ GStreamer å‘å¹³å°æŒ‡å®šçš„ IP/ç«¯å£æ¨é€PSè§†é¢‘æµã€‚
5. å¤„ç† **BYE**ã€**MESSAGE**ã€**SUBSCRIBE** å¹¶è¿”å› 200 OKã€‚
6. **è‡ªåŠ¨é‡è¿**ï¼šå½“è¿æ¥æ–­å¼€æ—¶ï¼Œè‡ªåŠ¨å°è¯•é‡æ–°è¿æ¥å’Œæ³¨å†Œã€‚

---

## ğŸ› ï¸ ä¸»è¦å‘½ä»¤è¡Œå‚æ•°

| å‚æ•°                         | é»˜è®¤                 | è¯´æ˜                                |
| -------------------------- | ------------------ | --------------------------------- |
| `--server-ip`              | *å¿…å¡«*               | å¹³å° SIP IP                         |
| `--server-port`            | 5060               | å¹³å° SIP ç«¯å£                         |
| `--server-id`              | *å¿…å¡«*               | å¹³å°å›½æ ‡ç¼–å·ï¼ˆ`PLAT_ID`ï¼‰                 |
| `--domain`                 | `server-id` å‰ 10 ä½ | SIP åŸŸ                             |
| `--agent-id`               | *å¿…å¡«*               | æœ¬è®¾å¤‡å›½æ ‡ç¼–å·                           |
| `--agent-password`         | *å¿…å¡«*               | REGISTER Digest å¯†ç                 |
| `--channel-id`             | *å¿…å¡«*               | ä¸ŠæŠ¥ç»™å¹³å°çš„é€šé“ç¼–å·                        |
| `--source`                 | *test*             | è§†é¢‘æº                              |
| `--udp`                    | *å…³é—­*               | ä½¿ç”¨ **UDP** è€Œéé»˜è®¤ **TCP** è¿›è¡Œ SIP äº¤äº’ |
| `--local-ip`               | è‡ªåŠ¨æ¢æµ‹               | ç»‘å®šæœ¬åœ°ç½‘å¡                            |
| `--verbose`                | *å…³é—­*               | è¾“å‡ºè°ƒè¯•æ—¥å¿—åŠå®Œæ•´ SIP æŠ¥æ–‡                  |
| `--reconnect-interval`     | 5                  | é‡è¿é—´éš”æ—¶é—´ï¼ˆç§’ï¼‰                         |
| `--max-reconnect-attempts` | 0                  | æœ€å¤§é‡è¿æ¬¡æ•°ï¼ˆ0 = æ— é™é‡è¿ï¼‰                  |
| `--connection-timeout`     | 10                 | è¿æ¥è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰                         |

å…¶ä¸­ `--source` å‚æ•°å¯æŒ‡å®šè§†é¢‘æºï¼Œæ”¯æŒå¤šç§æ ¼å¼ï¼š

| ç¤ºä¾‹                                                                    | æ•ˆæœ                    |
|-----------------------------------------------------------------------| --------------------- |
| `--source test`                                                       | å†…ç½® `videotestsrc`ï¼ˆé»˜è®¤ï¼‰ |
| `--source rtsp://admin:admin@192.168.111.222/h264/ch1/main/av_stream` | ä» RTSP æ‘„åƒæœºæ‹‰æµ          |
| `--source udp://:5000`                                                | ç›‘å¬ç»„æ’­ UDP ç æµ           |
| `--source file://sample.mp4`                                          | æ’­æ”¾æœ¬åœ°æ–‡ä»¶å¹¶æ¨æµ             |
| `--source v4l2:///dev/video0`                                         | ç›´æ¥é‡‡é›†æœ¬åœ°æ‘„åƒå¤´             |

---

## ğŸ“š é™„åŠ å·¥å…·

* [`Tools/BuildGB28181Server.md`](Tools/BuildGB28181Server.md)ï¼šè®°å½•äº†å¦‚ä½•æ­å»ºä¸€ä¸ªGB28181çš„åª’ä½“æœåŠ¡å™¨ï¼ŒåŸºäºZLMediaKitå’Œwvp-GB28181-proçš„ç»„åˆã€‚
* [`Tools/gb28181_proxy.py`](Tools/gb28181_proxy.py)ï¼šä¸€ä¸ªç®€å•çš„GB28181è½¬å‘ä»£ç†ï¼Œè®°å½•GB28181çš„ä¿¡ä»¤äº¤äº’è¿‡ç¨‹ï¼Œè®°å½•è§†é¢‘æµçš„åŸå§‹åŒ…ï¼Œä¸»è¦ç”¨äºç ”ç©¶å’Œè°ƒè¯•ï¼Œå¯é…åˆWiresharkæŠ“åŒ…ä½¿ç”¨ã€‚
> è®©æµ·åº·æˆ–è€…å…¶ä»–æ”¯æŒGB28181çš„è®¾å¤‡å‘æœ¬æœºçš„5060ç«¯å£æ³¨å†Œï¼Œå³å¯è½¬å‘åˆ°xxx.xxx.xxx.xxxçš„5060ç«¯å£ï¼Œå¹¶æŸ¥çœ‹æ•´ä¸ªäº¤äº’è¿‡ç¨‹ã€‚

```bash
python3 gb28181_proxy.py \
    --listen-host 0.0.0.0 \
    --listen-port 5060 \
    --server-host xxx.xxx.xxx.xxx \
    --server-port 5060
```

## ğŸ§‘â€ğŸ’» è¾…åŠ©ç¼–ç¨‹

OpenAI o3 å’Œ Gemini 2.5 Pro